---
export const prerender = false;

import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE } from '../consts';
import {
  getTotalPageViews,
  getPageViewsByPath,
  getDailyPageViews,
  getRecentPageViews,
  getHistoricalTotalViews,
  getDatabaseStats,
  isLikelyBot
} from '../lib/db';

// Check for authentication
const authToken = Astro.url.searchParams.get('token');
const expectedToken = import.meta.env.STATS_TOKEN || process.env.STATS_TOKEN;

if (!expectedToken) {
  return new Response('Stats page not configured. Please set STATS_TOKEN environment variable.', {
    status: 500
  });
}

// If no token in URL, return a page that checks localStorage or prompts
if (!authToken) {
  return new Response(`
    <!doctype html>
    <html>
      <head>
        <title>Stats - Authentication</title>
        <style>
          body { font-family: system-ui; background: #141d2b; color: #c5d1eb; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
          .auth-box { background: rgba(255,255,255,0.04); padding: 2rem; border-radius: 8px; text-align: center; }
          input { padding: 0.5rem 1rem; font-size: 1rem; border: 1px solid #5cecc6; background: #1a2332; color: #c5d1eb; border-radius: 4px; margin-right: 0.5rem; }
          button { padding: 0.5rem 1rem; font-size: 1rem; background: #5cecc6; color: #141d2b; border: none; border-radius: 4px; cursor: pointer; }
          button:hover { background: #9fef00; }
          .checking { opacity: 0.7; }
        </style>
      </head>
      <body>
        <div class="auth-box">
          <p class="checking">Checking authentication...</p>
          <form id="auth-form" style="display: none;">
            <input type="password" id="token-input" placeholder="Enter token" />
            <button type="submit">View Stats</button>
          </form>
        </div>
        <script>
          const stored = localStorage.getItem('stats_token');
          if (stored) {
            window.location.href = '/stats?token=' + encodeURIComponent(stored);
          } else {
            document.querySelector('.checking').style.display = 'none';
            document.getElementById('auth-form').style.display = 'block';
            document.getElementById('auth-form').addEventListener('submit', (e) => {
              e.preventDefault();
              const token = document.getElementById('token-input').value;
              if (token) {
                localStorage.setItem('stats_token', token);
                window.location.href = '/stats?token=' + encodeURIComponent(token);
              }
            });
          }
        </script>
      </body>
    </html>
  `, { headers: { 'Content-Type': 'text/html' } });
}

if (authToken !== expectedToken) {
  // Clear bad token from localStorage and show error
  return new Response(`
    <!doctype html>
    <html>
      <head>
        <title>Stats - Unauthorized</title>
        <style>
          body { font-family: system-ui; background: #141d2b; color: #c5d1eb; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
          .auth-box { background: rgba(255,255,255,0.04); padding: 2rem; border-radius: 8px; text-align: center; }
          .error { color: #ff3e3e; margin-bottom: 1rem; }
          a { color: #5cecc6; }
        </style>
      </head>
      <body>
        <div class="auth-box">
          <p class="error">Invalid token</p>
          <p><a href="/stats">Try again</a></p>
        </div>
        <script>
          localStorage.removeItem('stats_token');
        </script>
      </body>
    </html>
  `, { status: 401, headers: { 'Content-Type': 'text/html' } });
}

// Fetch stats data
const totalViews = getTotalPageViews();
const historicalViews = getHistoricalTotalViews();
const allTimeViews = totalViews + historicalViews;
const pageViews = getPageViewsByPath();
const dailyViews = getDailyPageViews(30);
const recentViews = getRecentPageViews(20);
const dbStats = getDatabaseStats();
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`Stats - ${SITE_TITLE}`} description="Site statistics and pageview analytics" />
    <style>
      .stats-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      .stat-card {
        background: var(--background-accent);
        padding: 1.5rem;
        margin-bottom: 2rem;
        border-radius: 8px;
      }

      .stat-card h2 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--text-primary);
      }

      .big-number {
        font-size: 3rem;
        font-weight: bold;
        color: var(--accent);
        margin: 0;
      }

      .stats-table {
        width: 100%;
        border-collapse: collapse;
      }

      .stats-table th,
      .stats-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }

      .stats-table th {
        font-weight: bold;
        background: var(--background-primary);
      }

      .stats-table tr:hover {
        background: var(--background-primary);
      }

      .path-column {
        font-family: monospace;
        color: var(--accent);
      }

      .views-column {
        text-align: right;
        font-weight: bold;
      }

      .date-column {
        white-space: nowrap;
      }

      .recent-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
      }

      .recent-item:last-child {
        border-bottom: none;
      }

      .recent-path {
        font-family: monospace;
        color: var(--accent);
      }

      .recent-time {
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
      }

      @media (max-width: 768px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <Header title={SITE_TITLE} />
      <main class="stats-container">
        <h1>Site Statistics</h1>

        <div class="stat-card">
          <h2>Total Pageviews (All Time)</h2>
          <p class="big-number">{allTimeViews.toLocaleString()}</p>
          {historicalViews > 0 && (
            <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.8;">
              {totalViews.toLocaleString()} recent + {historicalViews.toLocaleString()} archived
            </p>
          )}
        </div>

        <div class="grid-2">
          <div class="stat-card">
            <h2>Top Pages (All Time)</h2>
            <table class="stats-table">
              <thead>
                <tr>
                  <th>Page</th>
                  <th class="views-column">Views</th>
                </tr>
              </thead>
              <tbody>
                {pageViews.map((page) => (
                  <tr>
                    <td class="path-column">{page.path}</td>
                    <td class="views-column">{page.views.toLocaleString()}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <div class="stat-card">
            <h2>Daily Views (Last 30 Days)</h2>
            <table class="stats-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th class="views-column">Views</th>
                </tr>
              </thead>
              <tbody>
                {dailyViews.map((day) => (
                  <tr>
                    <td class="date-column">{day.date}</td>
                    <td class="views-column">{day.views.toLocaleString()}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        <div class="stat-card">
          <h2>Recent Pageviews</h2>
          {recentViews.map((view: any) => {
            const isBot = isLikelyBot(view.user_agent);
            return (
              <div class="recent-item">
                <div class="recent-path">
                  {isBot ? 'ðŸ¤–' : 'ðŸ‘¤'} {view.path}
                </div>
                <div class="recent-time">
                  {new Date(view.timestamp).toLocaleString()}
                  {view.referrer && ` â€¢ from ${new URL(view.referrer).hostname}`}
                </div>
              </div>
            );
          })}
        </div>

        <div class="stat-card">
          <h2>Database Stats</h2>
          <table class="stats-table">
            <tbody>
              <tr>
                <td>Detailed pageview records</td>
                <td class="views-column">{dbStats.pageviewRows.toLocaleString()}</td>
              </tr>
              <tr>
                <td>Archived daily stats records</td>
                <td class="views-column">{dbStats.dailyStatsRows.toLocaleString()}</td>
              </tr>
              {dbStats.oldestPageview && (
                <tr>
                  <td>Oldest detailed record</td>
                  <td class="views-column">{dbStats.oldestPageview.toLocaleDateString()}</td>
                </tr>
              )}
              {dbStats.oldestDailyStat && (
                <tr>
                  <td>Oldest archived record</td>
                  <td class="views-column">{dbStats.oldestDailyStat}</td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </main>
      <Footer />
    </div>
    <script is:inline>
      // Save token to localStorage for future visits
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      if (token) {
        localStorage.setItem('stats_token', token);
        // Clean URL (remove token from address bar)
        window.history.replaceState({}, '', '/stats');
      }
    </script>
  </body>
</html>
